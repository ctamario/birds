<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Uppträdandemönster av tre sibiriska tättingar i Norge och Sverige</title>

<script src="site_libs/header-attrs-2.25/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Visualisering av fågelobsar</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Tre sibbar i Norden</a>
</li>
<li>
  <a href="inornatus_eurasia.html">Tajgasångare i Eurasien</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Uppträdandemönster av tre sibiriska
tättingar i Norge och Sverige</h1>

</div>


<p>Data inkluderar alla observationer av a) sibirisk piplärka, b)
tajgasångare och c) kungsfågelsångare från och med 1990 till och med
2022 i Norge och Sverige. Alla observationer sammanslagna till “ett år”
som visar de tidsrumsliga uppträdandena av respektive art över en
säsong.</p>
<p>På första dagen av en ny observation dyker en blå punkt upp vilken
gradvis tonas ned i intensitet över fem dagar. Storleken på punkten är
logaritmiskt proportionell till hur många individer som observerades
(skillnaden i storlek mellan 1 och 2 individer är större än 20 och 21
individer).</p>
<p>Den röda punkten är medianen av alla observationer under en viss dag
där ett “rullande medelvärde” över fem dagar har applicerats för att
minska de ryckiga rörelserna. Den röda linjen visar hur medianen har
rört sig under säsongen. Färgstyrkan på linjen är proportionell till
antalet fynd då linjen ritades.</p>
<p>Något som bör beaktas i tolkningen av den röda linjen är att den
nödvändigtvis inte reflekterar migrationsriktning. Om kallfronten från
norr pressar ned fönstret under hösten kommer medianobservationen att
förflyttas söderut, även om det teoretiska inflödet är från
(nord/rakt/syd)-ostlig sektor.</p>
<p><img src="gifs/all_three.gif" /><!-- --></p>
<div id="bakomliggande-kod" class="section level2">
<h2>Bakomliggande kod</h2>
<p>Detta är ett arbetsflöde som endast gäller för svensk (<a
href="https://www.artportalen.se/"
class="uri">https://www.artportalen.se/</a>) och norsk (<a
href="https://www.artsobservasjoner.no/"
class="uri">https://www.artsobservasjoner.no/</a>) data. Optimalt bör
ett API användas för att hämta data direkt från portalerna med
reproducerbar kod, men för tillfället har den manuella exporten från
databasernas “Sök”-funktion använts: Exportera data till Excel, ta
därefter bort de första två raderna som innehåller exportparametrarna
och spara om till .csv.</p>
<p>Paket som används:</p>
<pre class="r"><code>library(pacman)
p_load(tidyr, sf, sp, ggplot2, rnaturalearth, rnaturalearthdata, gganimate, magick, zoo, dplyr, gridExtra)</code></pre>
<p>Import-funktioner som konverterar data från de olika portalerna till
samma koordinatsystem.</p>
<pre class="r"><code>input_swedish_data &lt;- function(in_data){
  df &lt;- st_as_sf(in_data, coords = c(&quot;Ost&quot;, &quot;Nord&quot;), crs=3021) 
  df$date &lt;- as.Date(df$Startdatum)
  df2 &lt;- st_transform(df, crs=4326)
  df2 &lt;- df2 %&gt;% dplyr::select(date,inds=Antal)
  df2 &lt;- df2 %&gt;% dplyr::filter(!is.na(as.numeric(inds)))
  return(df2)
}

input_norwegian_data &lt;- function(in_data){
  df &lt;- st_as_sf(in_data, coords = c(&quot;Østkoordinat&quot;, &quot;Nordkoordinat&quot;), crs=32633) 
  df$date &lt;- as.Date(df$Startdato)
  df2 &lt;- st_transform(df, crs=4326)
  df2 &lt;- df2 %&gt;% dplyr::select(date,inds=Antall)
  df2 &lt;- df2 %&gt;% dplyr::filter(!is.na(as.numeric(inds)))
  return(df2)
}</code></pre>
<p>Ladda in och bearbeta dataseten med hjälp av
“<code>input_*_data</code>”-funktionen.</p>
<pre class="r"><code># Norwegian data
inornatus_NO &lt;- read.csv(file=&quot;data/norge_tajga.csv&quot;, sep=&quot;;&quot;, dec=&quot;,&quot;)
hodgsoni_NO &lt;-read.csv(file=&quot;data/norge_sibpip.csv&quot;, sep=&quot;;&quot;, dec=&quot;,&quot;)
proregulus_NO &lt;- read.csv(file=&quot;data/norge_kfs.csv&quot;, sep=&quot;;&quot;, dec=&quot;,&quot;)

inornatus_NO_out &lt;- input_norwegian_data(inornatus_NO)
hodgsoni_NO_out &lt;-input_norwegian_data(hodgsoni_NO)
proregulus_NO_out &lt;-input_norwegian_data(proregulus_NO)

# Swedish data
inornatus_SE &lt;- read.csv(file=&quot;data/sverige_tajga.csv&quot;, sep=&quot;;&quot;, dec=&quot;,&quot;)
hodgsoni_SE &lt;- read.csv(file=&quot;data/sverige_sibpip.csv&quot;, sep=&quot;;&quot;, dec=&quot;,&quot;)
proregulus_SE &lt;- read.csv(file=&quot;data/sverige_kfs.csv&quot;, sep=&quot;;&quot;, dec=&quot;,&quot;)

inornatus_SE_out &lt;- input_swedish_data(inornatus_SE)
hodgsoni_SE_out &lt;-input_swedish_data(hodgsoni_SE)
proregulus_SE_out &lt;-input_swedish_data(proregulus_SE)</code></pre>
<p>Nedan är en funktion med tre delar som I) först lägger ihop det
svenska och norska datasetet, sedan II) femdubblar datasetet med
förskjutet datum för att plotta de gradvisa nedtoningarna av varje
observation och III) beräknar medianpositionen av observationerna och
applicerar ett rullande medelvärde.</p>
<pre class="r"><code>start &lt;- 240
end &lt;- 350

prepare_data &lt;- function(in_data1, in_data2) {
  
  ### Part I: merge the two datasets and create some variables
  
  df &lt;- rbind(in_data1, in_data2)
  df$jdate &lt;- as.numeric(format(df$date, &quot;%j&quot;))
  df$year &lt;- as.numeric(format(df$date, &quot;%Y&quot;))
  df$inds &lt;- as.numeric(df$inds)
  df$inds_size &lt;- round((log(df$inds) + 1), 1)
  df &lt;- df %&gt;%
    dplyr::mutate(lon = sf::st_coordinates(.)[, 1],
                  lat = sf::st_coordinates(.)[, 2])
  
  
  ### Part II: create data for the fading points
  
  # Initialize an empty list to store data frames
  fade_list &lt;- list()
  
  # Define alpha values
  alpha_values &lt;- c(0.5, 0.44, 0.34, 0.25, 0.16, 0.09)
  
  # Loop to create fade data frames
  for (i in 1:6) {
    fade &lt;- df
    fade$jdate &lt;- df$jdate + (i - 1)
    fade$alpha1 &lt;- alpha_values[i] / 10
    fade_list[[i]] &lt;- fade
  }
  
  # Combine the data frames into a single data frame
  df_tot &lt;- do.call(rbind, fade_list)
  
  
  ### Part III: Calculate the centroid of all the observations for each day and apply a rolling mean
  
  df_center &lt;- df %&gt;%
    group_by(jdate) %&gt;%
    summarise(
      lat_mean = mean(lat),
      lon_mean = mean(lon),
      lat_sd = sd(lat, na.rm = TRUE),
      lon_sd = sd(lon, na.rm = TRUE),
      lat_10 = quantile(lat, 0.1),
      lon_10 = quantile(lon, 0.1),
      lat_90 = quantile(lat, 0.9),
      lon_90 = quantile(lon, 0.9),
      n = n()
    )
  
  # Create a sequence of dates from start to end
  cent &lt;- data.frame(jdate = seq(start, end, by = 1))
  
  # Left join df_center with cent
  cent &lt;- left_join(cent, df_center, by = &quot;jdate&quot;)
  
  # Function to calculate rolling mean and update the column
  rolling_mean &lt;- function(x, window_size) {
    rollapply(x, window_size, FUN = function(y) mean(y, na.rm = TRUE), align = &quot;right&quot;)
  }
  
  # Columns to process
  columns_to_process &lt;-
    c(&quot;lat_mean&quot;, &quot;lon_mean&quot;, &quot;lat_10&quot;, &quot;lon_10&quot;, &quot;lat_90&quot;, &quot;lon_90&quot;)
  
  # Apply rolling mean to specified columns
  for (col in columns_to_process) {
    cent[[paste0(col, &quot;2&quot;)]] &lt;- cent[[col]]
    cent[[paste0(col, &quot;2&quot;)]][5:nrow(cent)] &lt;- rolling_mean(cent[[col]], 5)
  }
  
  # Calculate alpha2
  cent$alpha2 &lt;- cent$n / max(cent$n, na.rm = T)
  
  # Replace NA values in alpha2 with 0
  cent$alpha2[is.na(cent$alpha2)] &lt;- 0
  
  return(list(df_tot, cent))
}</code></pre>
<p>Skapa dataseten med hjälp av funktionen ovan.</p>
<pre class="r"><code>hodg &lt;- as.data.frame(prepare_data(hodgsoni_SE_out, hodgsoni_NO_out)[[1]])
hodg2 &lt;- prepare_data(hodgsoni_SE_out, hodgsoni_NO_out)[[2]]
inorn &lt;- as.data.frame(prepare_data(inornatus_SE_out, inornatus_NO_out)[[1]])
inorn2 &lt;- prepare_data(inornatus_SE_out, inornatus_NO_out)[[2]]
proreg &lt;- as.data.frame(prepare_data(proregulus_SE_out, proregulus_NO_out)[[1]])
proreg2 &lt;- prepare_data(proregulus_SE_out, proregulus_NO_out)[[2]]

hodg3 &lt;- hodg2 %&gt;% fill(c(lat_mean2,lon_mean2), .direction = &quot;downup&quot;) #Extrapolate the median 
inorn3 &lt;- inorn2 %&gt;% fill(c(lat_mean2,lon_mean2), .direction = &quot;downup&quot;)
proreg3 &lt;- proreg2 %&gt;% fill(c(lat_mean2,lon_mean2), .direction = &quot;downup&quot;)

world &lt;- ne_countries(scale = &quot;medium&quot;, returnclass = &quot;sf&quot;) #Load the background map</code></pre>
<p>Sedan görs en plott för dag med en loop.</p>
<pre class="r"><code>start &lt;- 280
end &lt;- 290

for(i in start:end){
  hodg_loop &lt;- hodg %&gt;% dplyr::filter(jdate == i)
  hodg2_loop &lt;- hodg2 %&gt;% dplyr::filter(jdate == i)
  inorn_loop &lt;- inorn %&gt;% dplyr::filter(jdate == i)
  inorn2_loop &lt;- inorn2 %&gt;% dplyr::filter(jdate == i)
  proreg_loop &lt;- proreg %&gt;% dplyr::filter(jdate == i)
  proreg2_loop &lt;- proreg2 %&gt;% dplyr::filter(jdate == i)
  
  p1 &lt;- ggplot(data = world) +
    geom_sf() +
    coord_sf(xlim = c(2.201912, 32), ylim = c(54.352533, 71.5), expand = FALSE)+
    geom_point(data=hodg_loop, 
               aes(y=lat, x=lon, alpha=alpha1, size=inds_size), color=&quot;mediumblue&quot;)+
    geom_point(data=hodg2_loop %&gt;% dplyr::filter(jdate==i), 
               aes(y=lat_mean2, x=lon_mean2, alpha=alpha2), size=4, color=&quot;red&quot;)+
    geom_path(data=hodg3 %&gt;% dplyr::filter(jdate &gt; 230 &amp; jdate &lt;= i), 
              aes(x=lon_mean2, y=lat_mean2, alpha=alpha2), color=&quot;red&quot;, size=2)+
    scale_alpha(limits = c(0.0, 1))+
    scale_size(limits =c(1,4))+
    ggtitle(paste0(&quot;Sibirisk piplärka: &quot;, format(as.Date(as.character(i), &quot;%j&quot;),&quot;%d %b&quot;)))+
    theme_classic() + 
    theme(legend.position = &quot;none&quot;)
  p2 &lt;- ggplot(data = world) +
    geom_sf() +
    coord_sf(xlim = c(2.201912, 32), ylim = c(54.352533, 71.5), expand = FALSE)+
    geom_point(data=inorn_loop, 
               aes(y=lat, x=lon, alpha=alpha1, size=inds_size), color=&quot;mediumblue&quot;)+
    geom_point(data=inorn2_loop, 
               aes(y=lat_mean2, x=lon_mean2, alpha=alpha2), size=4, color=&quot;red&quot;)+
    geom_path(data=inorn3 %&gt;% dplyr::filter(jdate &gt; 230 &amp; jdate &lt;= i), 
              aes(x=lon_mean2, y=lat_mean2, alpha=alpha2), color=&quot;red&quot;, size=2)+  
    scale_alpha(limits = c(0.0, 1))+
    scale_size(limits =c(1,4))+
    ggtitle(paste0(&quot;Tajgasångare: &quot;, format(as.Date(as.character(i), &quot;%j&quot;),&quot;%d %b&quot;)))+
    theme_classic() + 
    theme(legend.position = &quot;none&quot;)
  p3 &lt;- ggplot(data = world) +
    geom_sf() +
    coord_sf(xlim = c(2.201912, 32), ylim = c(54.352533, 71.5), expand = FALSE)+
    geom_point(data=proreg_loop, 
               aes(y=lat, x=lon, alpha=alpha1, size=inds_size), color=&quot;mediumblue&quot;)+
    geom_point(data=proreg2_loop, 
               aes(y=lat_mean2, x=lon_mean2, alpha=alpha2), size=4, color=&quot;red&quot;)+
    geom_path(data=proreg3 %&gt;% dplyr::filter(jdate &gt; 230 &amp; jdate &lt;= i), 
              aes(x=lon_mean2, y=lat_mean2, alpha=alpha2), color=&quot;red&quot;, size=2)+  
    scale_alpha(limits = c(0.0, 1))+
    scale_size(limits =c(1,4))+
    ggtitle(paste0(&quot;Kungsfågelsångare: &quot;, format(as.Date(as.character(i), &quot;%j&quot;),&quot;%d %b&quot;)))+
    theme_classic() + 
    theme(legend.position = &quot;none&quot;)
  p4 &lt;- grid.arrange(p1, p2, p3, nrow=1)
  ggsave(file=paste0(getwd(),&quot;/out/first&quot;,i,&quot;.png&quot;), plot=p4, width=10, height=6)
}</code></pre>
<p>…varefter bilderna sedan slås ihop till en gif.</p>
<pre class="r"><code>list.files(path=paste0(getwd(),&quot;/out/&quot;), pattern = &#39;*.png&#39;, full.names = TRUE) %&gt;% 
  image_read() %&gt;% # reads each path file
  image_join() %&gt;% # joins image
  image_animate(fps=12.500000, optimize=T) %&gt;% # animates, can opt for number of loops
  image_write(paste0(getwd(),&quot;/gifs/all_three.gif&quot;))</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
